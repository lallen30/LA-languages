import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';
import { StorageService } from './storage.service';

export type SupportedLanguage = 'en-US' | 'es-ES' | 'fr-FR' | 'pt-PT' | 'de-DE' | 'it-IT';

export interface Translations {
  [key: string]: string | Translations;
}

@Injectable({
  providedIn: 'root'
})
export class TranslationService {
  private currentLanguage$ = new BehaviorSubject<SupportedLanguage>('en-US');
  private translations: { [lang: string]: Translations } = {};

  constructor(private storageService: StorageService) {
    this.loadTranslations();
  }

  private loadTranslations() {
    // English translations (default)
    this.translations['en-US'] = {
      common: {
        save: 'Save',
        cancel: 'Cancel',
        delete: 'Delete',
        edit: 'Edit',
        close: 'Close',
        ok: 'OK',
        yes: 'Yes',
        no: 'No',
        confirm: 'Confirm',
        back: 'Back',
        next: 'Next',
        done: 'Done',
        loading: 'Loading...',
        error: 'Error',
        success: 'Success'
      },
      settings: {
        title: 'Settings',
        languageSettings: 'Language Settings',
        nativeLanguage: 'Native Language',
        targetLanguage: 'Target Language',
        nativeLanguageDesc: 'Language for app interface',
        targetLanguageDesc: 'Language you are learning',
        autoSpeak: 'Auto-speak on card flip',
        appearance: 'Appearance',
        study: 'Study',
        data: 'Data',
        about: 'About',
        // About modal
        helpGuide: 'Help & Guide',
        helpGuideDesc: 'Learn how to use the spaced repetition system',
        appName: 'LA Languages App',
        buyMeCoffee: 'Buy me a coffee',
        supportDev: 'Support the development of this app',
        // Appearance modal
        darkMode: 'Dark Mode',
        primaryColors: 'Primary Colors',
        primaryColor: 'Primary Color',
        secondaryColor: 'Secondary Color',
        tertiaryColor: 'Tertiary Color',
        backgroundColors: 'Background Colors',
        pageBackground: 'Page Background',
        cardBackground: 'Card Background',
        itemBackground: 'Item Background',
        textColors: 'Text Colors',
        primaryText: 'Primary Text',
        secondaryText: 'Secondary Text',
        cardText: 'Card Text',
        itemText: 'Item Text',
        buttonColors: 'Button Colors',
        buttonBackground: 'Button Background',
        buttonText: 'Button Text',
        outlinedButton: 'Outlined Button',
        headerFooterColors: 'Header/Footer Colors',
        headerBackground: 'Header Background',
        headerText: 'Header Text',
        footerBackground: 'Footer Background',
        footerText: 'Footer Text',
        flashcardActionBar: 'Flashcard Action Bar Colors',
        hardButtonBg: 'Hard Button Background',
        hardButtonTxt: 'Hard Button Text',
        goodButtonBg: 'Good Button Background',
        goodButtonTxt: 'Good Button Text',
        easyButtonBg: 'Easy Button Background',
        easyButtonTxt: 'Easy Button Text',
        incorrectButtonBg: 'I Don\'t Know Button Background',
        incorrectButtonTxt: 'I Don\'t Know Button Text',
        resetToDefault: 'Reset to Default',
        done: 'Done',
        // Study modal
        studySettings: 'Study Settings',
        maxCardsPerSession: 'Max cards per session',
        pictureWordCards: 'Picture Word Cards',
        chooseWhatToShow: 'Choose what to show first',
        imagesFirst: 'Images First',
        wordFirst: 'Word First',
        random: 'Random',
        // Data modal
        exportData: 'Export Data',
        importData: 'Import Data',
        importMultipleDecks: 'Import Multiple Decks (File)',
        importMultipleDecksFromUrl: 'Import Multiple Decks (URL)',
        importFromUrl: 'Import from URL',
        enterUrlForDecks: 'Enter the URL of the JSON file containing decks and cards:',
        resetSettings: 'Reset Settings',
        deleteAllData: 'Delete All Data',
        // Toast messages
        unableToOpenModal: 'Unable to open modal',
        settingSaved: 'Setting saved',
        errorSavingSetting: 'Error saving setting',
        ttsFailed: 'TTS test failed',
        allDataCleared: 'All data cleared',
        dataExported: 'Data exported successfully',
        exportFailed: 'Export failed',
        dataImported: 'Data imported successfully',
        importFailed: 'Import failed - invalid file',
        invalidFileFormat: 'Invalid file format - must contain cards and decks',
        decksImported: 'Decks imported successfully',
        settingsReset: 'Settings reset to defaults',
        colorsReset: 'Colors reset to default!',
        colorPreview: 'Color preview applied!',
        colorUpdated: 'updated to',
        errorColorPicker: 'Error opening color picker',
        colorSaved: 'saved',
        // Alert messages
        resetSettingsTitle: 'Reset Settings',
        resetSettingsMsg: 'This will reset all settings to their default values. Are you sure?',
        resetDataTitle: 'Reset All Data',
        resetDataMsg: 'This will delete ALL your decks, cards, and progress. This cannot be undone!',
        importDataTitle: 'Import Data',
        importDataMsg: 'This will replace all current data. Continue?',
        importDecksTitle: 'Import Multiple Decks',
        importDecksMsg: 'This will add',
        deckAnd: 'deck(s) and',
        cardTo: 'card(s) to your existing data. Continue?',
        selectedColor: 'Selected color',
        // Color picker
        presetColors: 'Preset colors',
        addColor: 'ADD COLOR',
        select: 'SELECT'
      },
      tabs: {
        home: 'Home',
        decks: 'Decks',
        stats: 'Stats',
        settings: 'Settings'
      },
      home: {
        title: 'Study',
        noCards: 'No cards to study',
        flip: 'Flip',
        showAnswer: 'Show Answer',
        hard: 'Hard',
        good: 'Good',
        easy: 'Easy',
        incorrect: 'Incorrect',
        correct: 'Correct',
        sessionComplete: 'Session Complete!',
        cardsStudied: 'Cards Studied',
        continueStudying: 'Continue Studying',
        reviewMissed: 'Review Missed Cards'
      },
      decks: {
        title: 'Decks',
        createDeck: 'Create Deck',
        createNewDeck: 'Create New Deck',
        editDeck: 'Edit Deck',
        deleteDeck: 'Delete Deck',
        deleteConfirm: 'Are you sure you want to delete this deck?',
        addCard: 'Add Card',
        addCards: 'Add Cards',
        viewStats: 'View Stats',
        study: 'Study',
        deckName: 'Deck Name',
        description: 'Description',
        cards: 'cards',
        noDecks: 'No decks yet',
        createFirst: 'Create your first deck to get started',
        refreshDecks: 'Refresh Decks',
        importDecks: 'Import Decks',
        importFromFile: 'Import from File',
        importFromUrl: 'Import from URL',
        exportDeck: 'Export Deck',
        warning: 'Warning',
        importWarning: 'Importing will replace all existing decks for the current language. Do you want to continue?',
        importFailed: 'Import Failed',
        importFailedMessage: 'Failed to download or parse deck from URL',
        enterUrl: 'Enter the URL to a deck JSON file:',
        deckProgress: 'Deck Progress',
        overview: 'Overview',
        accuracy: 'Accuracy',
        lastReview: 'Last review',
        never: 'Never',
        today: 'Today',
        yesterday: 'Yesterday',
        daysAgo: 'days ago',
        loading: 'Loading...',
        loadingStats: 'Loading statistics...',
        fillInBlank: 'Fill in the Blank',
        pictureWord: 'Picture Word',
        translate: 'Translate',
        manageCards: 'Manage Cards',
        // Toast messages
        decksRefreshed: 'Decks refreshed successfully!',
        errorRefreshing: 'Error refreshing decks',
        deckCreated: 'Deck created successfully!',
        deckUpdated: 'Deck updated successfully!',
        deckDeleted: 'Deck deleted successfully!',
        deckDeleteFailed: 'Failed to delete deck. Please try again.',
        enterDeckName: 'Please enter a deck name',
        cardCreated: 'Card created successfully!',
        fillBlankCreated: 'Fill-in-the-blank card created successfully!',
        pictureCardCreated: 'Picture word card created successfully!',
        translateCardCreated: 'Translation card created successfully!',
        errorSavingCard: 'Error saving card. Please try again.',
        importSuccess: 'Successfully imported',
        withCards: 'with',
        cards2: 'cards',
        importFailed2: 'Import failed'
      },
      stats: {
        title: 'Statistics',
        totalCards: 'Total Cards',
        mastered: 'Mastered',
        learning: 'Learning',
        new: 'New',
        studyStreak: 'Study Streak',
        days: 'days',
        metricsTitle: 'What do these metrics mean?',
        masteredDesc: 'Cards you\'ve reviewed successfully 3+ times',
        streakDesc: 'Consecutive days you\'ve studied (resets if you skip a day)',
        accuracyDesc: 'Percentage of reviewed cards you got right',
        noStatsYet: 'No Statistics Yet',
        startStudying: 'Start studying some decks to see your progress!',
        resetStats: 'Reset Statistics',
        resetConfirm: 'Are you sure you want to reset all statistics? This cannot be undone.',
        total: 'Total',
        review: 'Review'
      }
    };

    // Spanish translations
    this.translations['es-ES'] = {
      common: {
        save: 'Guardar',
        cancel: 'Cancelar',
        delete: 'Eliminar',
        edit: 'Editar',
        close: 'Cerrar',
        ok: 'OK',
        yes: 'Sí',
        no: 'No',
        confirm: 'Confirmar',
        back: 'Atrás',
        next: 'Siguiente',
        done: 'Hecho',
        loading: 'Cargando...',
        error: 'Error',
        success: 'Éxito'
      },
      settings: {
        title: 'Configuración',
        languageSettings: 'Configuración de Idioma',
        nativeLanguage: 'Idioma Nativo',
        targetLanguage: 'Idioma Objetivo',
        nativeLanguageDesc: 'Idioma de la interfaz',
        targetLanguageDesc: 'Idioma que estás aprendiendo',
        autoSpeak: 'Hablar automáticamente al voltear',
        appearance: 'Apariencia',
        study: 'Estudio',
        data: 'Datos',
        about: 'Acerca de',
        helpGuide: 'Ayuda y Guía',
        helpGuideDesc: 'Aprende a usar el sistema de repetición espaciada',
        appName: 'Aplicación LA Languages',
        buyMeCoffee: 'Cómprame un café',
        supportDev: 'Apoya el desarrollo de esta aplicación',
        darkMode: 'Modo Oscuro',
        primaryColors: 'Colores Primarios',
        primaryColor: 'Color Primario',
        secondaryColor: 'Color Secundario',
        tertiaryColor: 'Color Terciario',
        backgroundColors: 'Colores de Fondo',
        pageBackground: 'Fondo de Página',
        cardBackground: 'Fondo de Tarjeta',
        itemBackground: 'Fondo de Elemento',
        textColors: 'Colores de Texto',
        primaryText: 'Texto Primario',
        secondaryText: 'Texto Secundario',
        cardText: 'Texto de Tarjeta',
        itemText: 'Texto de Elemento',
        buttonColors: 'Colores de Botón',
        buttonBackground: 'Fondo de Botón',
        buttonText: 'Texto de Botón',
        outlinedButton: 'Botón Delineado',
        headerFooterColors: 'Colores de Encabezado/Pie',
        headerBackground: 'Fondo de Encabezado',
        headerText: 'Texto de Encabezado',
        footerBackground: 'Fondo de Pie',
        footerText: 'Texto de Pie',
        flashcardActionBar: 'Colores de Barra de Acción de Tarjetas',
        hardButtonBg: 'Fondo Botón Difícil',
        hardButtonTxt: 'Texto Botón Difícil',
        goodButtonBg: 'Fondo Botón Bien',
        goodButtonTxt: 'Texto Botón Bien',
        easyButtonBg: 'Fondo Botón Fácil',
        easyButtonTxt: 'Texto Botón Fácil',
        incorrectButtonBg: 'Fondo Botón No Sé',
        incorrectButtonTxt: 'Texto Botón No Sé',
        resetToDefault: 'Restablecer a Predeterminado',
        done: 'Hecho',
        studySettings: 'Configuración de Estudio',
        maxCardsPerSession: 'Máximo de tarjetas por sesión',
        pictureWordCards: 'Tarjetas de Palabra con Imagen',
        chooseWhatToShow: 'Elige qué mostrar primero',
        imagesFirst: 'Imágenes Primero',
        wordFirst: 'Palabra Primero',
        random: 'Aleatorio',
        exportData: 'Exportar Datos',
        importData: 'Importar Datos',
        importMultipleDecks: 'Importar Múltiples Mazos (Archivo)',
        importMultipleDecksFromUrl: 'Importar Múltiples Mazos (URL)',
        importFromUrl: 'Importar desde URL',
        enterUrlForDecks: 'Ingrese la URL del archivo JSON que contiene mazos y tarjetas:',
        resetSettings: 'Restablecer Configuración',
        deleteAllData: 'Eliminar Todos los Datos',
        unableToOpenModal: 'No se puede abrir el modal',
        settingSaved: 'Configuración guardada',
        errorSavingSetting: 'Error al guardar la configuración',
        ttsFailed: 'Prueba de TTS fallida',
        allDataCleared: 'Todos los datos eliminados',
        dataExported: 'Datos exportados exitosamente',
        exportFailed: 'Exportación fallida',
        dataImported: 'Datos importados exitosamente',
        importFailed: 'Importación fallida - archivo inválido',
        invalidFileFormat: 'Formato de archivo inválido - debe contener tarjetas y mazos',
        decksImported: 'Mazos importados exitosamente',
        settingsReset: 'Configuración restablecida a valores predeterminados',
        colorsReset: '¡Colores restablecidos a predeterminados!',
        colorPreview: '¡Vista previa de color aplicada!',
        colorUpdated: 'actualizado a',
        errorColorPicker: 'Error al abrir el selector de color',
        colorSaved: 'guardado',
        resetSettingsTitle: 'Restablecer Configuración',
        resetSettingsMsg: 'Esto restablecerá todas las configuraciones a sus valores predeterminados. ¿Estás seguro?',
        resetDataTitle: 'Restablecer Todos los Datos',
        resetDataMsg: '¡Esto eliminará TODOS tus mazos, tarjetas y progreso. Esto no se puede deshacer!',
        importDataTitle: 'Importar Datos',
        importDataMsg: 'Esto reemplazará todos los datos actuales. ¿Continuar?',
        importDecksTitle: 'Importar Múltiples Mazos',
        importDecksMsg: 'Esto agregará',
        deckAnd: 'mazo(s) y',
        cardTo: 'tarjeta(s) a tus datos existentes. ¿Continuar?',
        selectedColor: 'Color seleccionado',
        presetColors: 'Colores predefinidos',
        addColor: 'AGREGAR COLOR',
        select: 'SELECCIONAR'
      },
      tabs: {
        home: 'Inicio',
        decks: 'Mazos',
        stats: 'Estadísticas',
        settings: 'Configuración'
      },
      home: {
        title: 'Estudiar',
        noCards: 'No hay tarjetas para estudiar',
        flip: 'Voltear',
        showAnswer: 'Mostrar Respuesta',
        hard: 'Difícil',
        good: 'Bien',
        easy: 'Fácil',
        incorrect: 'Incorrecto',
        correct: 'Correcto',
        sessionComplete: '¡Sesión Completa!',
        cardsStudied: 'Tarjetas Estudiadas',
        continueStudying: 'Continuar Estudiando',
        reviewMissed: 'Revisar Tarjetas Falladas'
      },
      decks: {
        title: 'Mazos',
        createDeck: 'Crear Mazo',
        createNewDeck: 'Crear Nuevo Mazo',
        editDeck: 'Editar Mazo',
        deleteDeck: 'Eliminar Mazo',
        deleteConfirm: '¿Estás seguro de que quieres eliminar este mazo?',
        addCard: 'Agregar Tarjeta',
        addCards: 'Agregar Tarjetas',
        viewStats: 'Ver Estadísticas',
        study: 'Estudiar',
        deckName: 'Nombre del Mazo',
        description: 'Descripción',
        cards: 'tarjetas',
        noDecks: 'No hay mazos todavía',
        createFirst: 'Crea tu primer mazo para comenzar',
        refreshDecks: 'Actualizar Mazos',
        importDecks: 'Importar Mazos',
        importFromFile: 'Importar desde Archivo',
        importFromUrl: 'Importar desde URL',
        exportDeck: 'Exportar Mazo',
        warning: 'Advertencia',
        importWarning: 'Importar reemplazará todos los mazos existentes para el idioma actual. ¿Deseas continuar?',
        importFailed: 'Importación Fallida',
        importFailedMessage: 'No se pudo descargar o analizar el mazo desde la URL',
        enterUrl: 'Ingresa la URL a un archivo JSON de mazo:',
        deckProgress: 'Progreso del Mazo',
        overview: 'Resumen',
        accuracy: 'Precisión',
        lastReview: 'Última revisión',
        never: 'Nunca',
        today: 'Hoy',
        yesterday: 'Ayer',
        daysAgo: 'días atrás',
        loading: 'Cargando...',
        loadingStats: 'Cargando estadísticas...',
        fillInBlank: 'Completar el Espacio',
        pictureWord: 'Palabra con Imagen',
        translate: 'Traducir',
        manageCards: 'Administrar Tarjetas',
        // Toast messages
        decksRefreshed: '¡Mazos actualizados exitosamente!',
        errorRefreshing: 'Error al actualizar mazos',
        deckCreated: '¡Mazo creado exitosamente!',
        deckUpdated: '¡Mazo actualizado exitosamente!',
        deckDeleted: '¡Mazo eliminado exitosamente!',
        deckDeleteFailed: 'Error al eliminar el mazo. Por favor, inténtalo de nuevo.',
        enterDeckName: 'Por favor ingresa un nombre para el mazo',
        cardCreated: '¡Tarjeta creada exitosamente!',
        fillBlankCreated: '¡Tarjeta de completar el espacio creada exitosamente!',
        pictureCardCreated: '¡Tarjeta de palabra con imagen creada exitosamente!',
        translateCardCreated: '¡Tarjeta de traducción creada exitosamente!',
        errorSavingCard: 'Error al guardar la tarjeta. Por favor, inténtalo de nuevo.',
        importSuccess: 'Importado exitosamente',
        withCards: 'con',
        cards2: 'tarjetas',
        importFailed2: 'Importación fallida'
      },
      stats: {
        title: 'Estadísticas',
        totalCards: 'Tarjetas Totales',
        mastered: 'Dominadas',
        learning: 'Aprendiendo',
        new: 'Nuevas',
        studyStreak: 'Racha de Estudio',
        days: 'días',
        metricsTitle: '¿Qué significan estas métricas?',
        masteredDesc: 'Tarjetas que has revisado exitosamente 3+ veces',
        streakDesc: 'Días consecutivos que has estudiado (se reinicia si te saltas un día)',
        accuracyDesc: 'Porcentaje de tarjetas revisadas que acertaste',
        noStatsYet: 'No Hay Estadísticas Todavía',
        startStudying: '¡Comienza a estudiar algunos mazos para ver tu progreso!',
        resetStats: 'Restablecer Estadísticas',
        resetConfirm: '¿Estás seguro de que quieres restablecer todas las estadísticas? Esto no se puede deshacer.',
        total: 'Total',
        review: 'Revisar'
      }
    };

    // French translations
    this.translations['fr-FR'] = {
      common: {
        save: 'Enregistrer',
        cancel: 'Annuler',
        delete: 'Supprimer',
        edit: 'Modifier',
        close: 'Fermer',
        ok: 'OK',
        yes: 'Oui',
        no: 'Non',
        confirm: 'Confirmer',
        back: 'Retour',
        next: 'Suivant',
        done: 'Terminé',
        loading: 'Chargement...',
        error: 'Erreur',
        success: 'Succès'
      },
      settings: {
        title: 'Paramètres',
        languageSettings: 'Paramètres de Langue',
        nativeLanguage: 'Langue Maternelle',
        targetLanguage: 'Langue Cible',
        nativeLanguageDesc: 'Langue de l\'interface',
        targetLanguageDesc: 'Langue que vous apprenez',
        autoSpeak: 'Lecture automatique au retournement',
        appearance: 'Apparence',
        study: 'Étude',
        data: 'Données et Sauvegarde',
        about: 'À propos',
        darkMode: 'Mode Sombre',
        resetSettings: 'Réinitialiser les Paramètres',
        resetData: 'Réinitialiser Toutes les Données',
        exportData: 'Exporter les Données',
        importData: 'Importer les Données'
      },
      tabs: {
        home: 'Accueil',
        decks: 'Paquets',
        stats: 'Statistiques',
        settings: 'Paramètres'
      },
      home: {
        title: 'Étudier',
        noCards: 'Aucune carte à étudier',
        flip: 'Retourner',
        showAnswer: 'Afficher la Réponse',
        hard: 'Difficile',
        good: 'Bien',
        easy: 'Facile',
        incorrect: 'Incorrect',
        correct: 'Correct',
        sessionComplete: 'Session Terminée!',
        cardsStudied: 'Cartes Étudiées',
        continueStudying: 'Continuer à Étudier',
        reviewMissed: 'Revoir les Cartes Manquées'
      },
      decks: {
        title: 'Paquets',
        createDeck: 'Créer un Paquet',
        createNewDeck: 'Créer un Nouveau Paquet',
        editDeck: 'Modifier le Paquet',
        deleteDeck: 'Supprimer le Paquet',
        deleteConfirm: 'Êtes-vous sûr de vouloir supprimer ce paquet?',
        addCard: 'Ajouter une Carte',
        addCards: 'Ajouter des Cartes',
        viewStats: 'Voir les Statistiques',
        study: 'Étudier',
        deckName: 'Nom du Paquet',
        description: 'Description',
        cards: 'cartes',
        noDecks: 'Aucun paquet pour le moment',
        createFirst: 'Créez votre premier paquet pour commencer',
        refreshDecks: 'Actualiser les Paquets',
        importDecks: 'Importer des Paquets',
        importFromFile: 'Importer depuis un Fichier',
        importFromUrl: 'Importer depuis une URL',
        exportDeck: 'Exporter le Paquet',
        warning: 'Avertissement',
        importWarning: 'L\'importation remplacera tous les paquets existants pour la langue actuelle. Voulez-vous continuer?',
        importFailed: 'Échec de l\'Importation',
        importFailedMessage: 'Impossible de télécharger ou d\'analyser le paquet depuis l\'URL',
        enterUrl: 'Entrez l\'URL d\'un fichier JSON de paquet:',
        deckProgress: 'Progrès du Paquet',
        overview: 'Aperçu',
        accuracy: 'Précision',
        lastReview: 'Dernière révision',
        never: 'Jamais',
        today: 'Aujourd\'hui',
        yesterday: 'Hier',
        daysAgo: 'il y a jours',
        loading: 'Chargement...',
        loadingStats: 'Chargement des statistiques...',
        fillInBlank: 'Remplir le Blanc',
        pictureWord: 'Mot avec Image',
        translate: 'Traduire',
        manageCards: 'Gérer les Cartes',
        decksRefreshed: 'Paquets actualisés avec succès!',
        errorRefreshing: 'Erreur lors de l\'actualisation des paquets',
        deckCreated: 'Paquet créé avec succès!',
        deckUpdated: 'Paquet mis à jour avec succès!',
        deckDeleted: 'Paquet supprimé avec succès!',
        deckDeleteFailed: 'Échec de la suppression du paquet. Veuillez réessayer.',
        enterDeckName: 'Veuillez entrer un nom de paquet',
        cardCreated: 'Carte créée avec succès!',
        fillBlankCreated: 'Carte à remplir créée avec succès!',
        pictureCardCreated: 'Carte mot-image créée avec succès!',
        translateCardCreated: 'Carte de traduction créée avec succès!',
        errorSavingCard: 'Erreur lors de l\'enregistrement de la carte. Veuillez réessayer.',
        importSuccess: 'Importé avec succès',
        withCards: 'avec',
        cards2: 'cartes',
        importFailed2: 'Échec de l\'importation'
      },
      stats: {
        title: 'Statistiques',
        totalCards: 'Cartes Totales',
        mastered: 'Maîtrisées',
        learning: 'En Apprentissage',
        new: 'Nouvelles',
        studyStreak: 'Série d\'Étude',
        days: 'jours',
        metricsTitle: 'Que signifient ces métriques?',
        masteredDesc: 'Cartes que vous avez révisées avec succès 3+ fois',
        streakDesc: 'Jours consécutifs d\'étude (réinitialisé si vous sautez un jour)',
        accuracyDesc: 'Pourcentage de cartes révisées correctement',
        noStatsYet: 'Pas Encore de Statistiques',
        startStudying: 'Commencez à étudier des paquets pour voir vos progrès!',
        resetStats: 'Réinitialiser les Statistiques',
        resetConfirm: 'Êtes-vous sûr de vouloir réinitialiser toutes les statistiques? Cela ne peut pas être annulé.',
        total: 'Total',
        review: 'Réviser'
      }
    };

    // Portuguese translations
    this.translations['pt-PT'] = {
      common: {
        save: 'Salvar',
        cancel: 'Cancelar',
        delete: 'Excluir',
        edit: 'Editar',
        close: 'Fechar',
        ok: 'OK',
        yes: 'Sim',
        no: 'Não',
        confirm: 'Confirmar',
        back: 'Voltar',
        next: 'Próximo',
        done: 'Concluído',
        loading: 'Carregando...',
        error: 'Erro',
        success: 'Sucesso'
      },
      settings: {
        title: 'Configurações',
        languageSettings: 'Configurações de Idioma',
        nativeLanguage: 'Idioma Nativo',
        targetLanguage: 'Idioma Alvo',
        nativeLanguageDesc: 'Idioma da interface',
        targetLanguageDesc: 'Idioma que você está aprendendo',
        autoSpeak: 'Falar automaticamente ao virar',
        appearance: 'Aparência',
        study: 'Estudo',
        data: 'Dados e Backup',
        about: 'Sobre',
        darkMode: 'Modo Escuro',
        resetSettings: 'Redefinir Configurações',
        resetData: 'Redefinir Todos os Dados',
        exportData: 'Exportar Dados',
        importData: 'Importar Dados'
      },
      tabs: {
        home: 'Início',
        decks: 'Baralhos',
        stats: 'Estatísticas',
        settings: 'Configurações'
      },
      home: {
        title: 'Estudar',
        noCards: 'Nenhum cartão para estudar',
        flip: 'Virar',
        showAnswer: 'Mostrar Resposta',
        hard: 'Difícil',
        good: 'Bom',
        easy: 'Fácil',
        incorrect: 'Incorreto',
        correct: 'Correto',
        sessionComplete: 'Sessão Completa!',
        cardsStudied: 'Cartões Estudados',
        continueStudying: 'Continuar Estudando',
        reviewMissed: 'Revisar Cartões Perdidos'
      },
      decks: {
        title: 'Baralhos',
        createDeck: 'Criar Baralho',
        createNewDeck: 'Criar Novo Baralho',
        editDeck: 'Editar Baralho',
        deleteDeck: 'Excluir Baralho',
        deleteConfirm: 'Tem certeza de que deseja excluir este baralho?',
        addCard: 'Adicionar Cartão',
        addCards: 'Adicionar Cartões',
        viewStats: 'Ver Estatísticas',
        study: 'Estudar',
        deckName: 'Nome do Baralho',
        description: 'Descrição',
        cards: 'cartões',
        noDecks: 'Nenhum baralho ainda',
        createFirst: 'Crie seu primeiro baralho para começar',
        refreshDecks: 'Atualizar Baralhos',
        importDecks: 'Importar Baralhos',
        importFromFile: 'Importar de Arquivo',
        importFromUrl: 'Importar de URL',
        exportDeck: 'Exportar Baralho',
        warning: 'Aviso',
        importWarning: 'A importação substituirá todos os baralhos existentes para o idioma atual. Deseja continuar?',
        importFailed: 'Importação Falhou',
        importFailedMessage: 'Falha ao baixar ou analisar o baralho da URL',
        enterUrl: 'Digite a URL para um arquivo JSON de baralho:',
        deckProgress: 'Progresso do Baralho',
        overview: 'Visão Geral',
        accuracy: 'Precisão',
        lastReview: 'Última revisão',
        never: 'Nunca',
        today: 'Hoje',
        yesterday: 'Ontem',
        daysAgo: 'dias atrás',
        loading: 'Carregando...',
        loadingStats: 'Carregando estatísticas...',
        fillInBlank: 'Preencher o Espaço',
        pictureWord: 'Palavra com Imagem',
        translate: 'Traduzir',
        manageCards: 'Gerenciar Cartões',
        decksRefreshed: 'Baralhos atualizados com sucesso!',
        errorRefreshing: 'Erro ao atualizar baralhos',
        deckCreated: 'Baralho criado com sucesso!',
        deckUpdated: 'Baralho atualizado com sucesso!',
        deckDeleted: 'Baralho excluído com sucesso!',
        deckDeleteFailed: 'Falha ao excluir o baralho. Por favor, tente novamente.',
        enterDeckName: 'Por favor, insira um nome para o baralho',
        cardCreated: 'Cartão criado com sucesso!',
        fillBlankCreated: 'Cartão de preencher espaço criado com sucesso!',
        pictureCardCreated: 'Cartão de palavra com imagem criado com sucesso!',
        translateCardCreated: 'Cartão de tradução criado com sucesso!',
        errorSavingCard: 'Erro ao salvar o cartão. Por favor, tente novamente.',
        importSuccess: 'Importado com sucesso',
        withCards: 'com',
        cards2: 'cartões',
        importFailed2: 'Importação falhou'
      },
      stats: {
        title: 'Estatísticas',
        totalCards: 'Cartões Totais',
        mastered: 'Dominados',
        learning: 'Aprendendo',
        new: 'Novos',
        studyStreak: 'Sequência de Estudo',
        days: 'dias',
        metricsTitle: 'O que significam essas métricas?',
        masteredDesc: 'Cartões que você revisou com sucesso 3+ vezes',
        streakDesc: 'Dias consecutivos de estudo (reinicia se você pular um dia)',
        accuracyDesc: 'Porcentagem de cartões revisados corretamente',
        noStatsYet: 'Ainda Sem Estatísticas',
        startStudying: 'Comece a estudar alguns baralhos para ver seu progresso!',
        resetStats: 'Redefinir Estatísticas',
        resetConfirm: 'Tem certeza de que deseja redefinir todas as estatísticas? Isso não pode ser desfeito.',
        total: 'Total',
        review: 'Revisar'
      }
    };

    // German translations
    this.translations['de-DE'] = {
      common: {
        save: 'Speichern',
        cancel: 'Abbrechen',
        delete: 'Löschen',
        edit: 'Bearbeiten',
        close: 'Schließen',
        ok: 'OK',
        yes: 'Ja',
        no: 'Nein',
        confirm: 'Bestätigen',
        back: 'Zurück',
        next: 'Weiter',
        done: 'Fertig',
        loading: 'Laden...',
        error: 'Fehler',
        success: 'Erfolg'
      },
      settings: {
        title: 'Einstellungen',
        languageSettings: 'Spracheinstellungen',
        nativeLanguage: 'Muttersprache',
        targetLanguage: 'Zielsprache',
        nativeLanguageDesc: 'Sprache der Benutzeroberfläche',
        targetLanguageDesc: 'Sprache, die Sie lernen',
        autoSpeak: 'Automatisch sprechen beim Umdrehen',
        appearance: 'Aussehen',
        study: 'Lernen',
        data: 'Daten & Sicherung',
        about: 'Über',
        darkMode: 'Dunkler Modus',
        resetSettings: 'Einstellungen Zurücksetzen',
        resetData: 'Alle Daten Zurücksetzen',
        exportData: 'Daten Exportieren',
        importData: 'Daten Importieren'
      },
      tabs: {
        home: 'Startseite',
        decks: 'Stapel',
        stats: 'Statistiken',
        settings: 'Einstellungen'
      },
      home: {
        title: 'Lernen',
        noCards: 'Keine Karten zum Lernen',
        flip: 'Umdrehen',
        showAnswer: 'Antwort Zeigen',
        hard: 'Schwer',
        good: 'Gut',
        easy: 'Leicht',
        incorrect: 'Falsch',
        correct: 'Richtig',
        sessionComplete: 'Sitzung Abgeschlossen!',
        cardsStudied: 'Gelernte Karten',
        continueStudying: 'Weiter Lernen',
        reviewMissed: 'Verpasste Karten Wiederholen'
      },
      decks: {
        title: 'Stapel',
        createDeck: 'Stapel Erstellen',
        createNewDeck: 'Neuen Stapel Erstellen',
        editDeck: 'Stapel Bearbeiten',
        deleteDeck: 'Stapel Löschen',
        deleteConfirm: 'Sind Sie sicher, dass Sie diesen Stapel löschen möchten?',
        addCard: 'Karte Hinzufügen',
        addCards: 'Karten Hinzufügen',
        viewStats: 'Statistiken Anzeigen',
        study: 'Lernen',
        deckName: 'Stapelname',
        description: 'Beschreibung',
        cards: 'Karten',
        noDecks: 'Noch keine Stapel',
        createFirst: 'Erstellen Sie Ihren ersten Stapel',
        refreshDecks: 'Stapel Aktualisieren',
        importDecks: 'Stapel Importieren',
        importFromFile: 'Aus Datei Importieren',
        importFromUrl: 'Von URL Importieren',
        exportDeck: 'Stapel Exportieren',
        warning: 'Warnung',
        importWarning: 'Beim Importieren werden alle vorhandenen Stapel für die aktuelle Sprache ersetzt. Möchten Sie fortfahren?',
        importFailed: 'Import Fehlgeschlagen',
        importFailedMessage: 'Fehler beim Herunterladen oder Parsen des Stapels von der URL',
        enterUrl: 'Geben Sie die URL zu einer Stapel-JSON-Datei ein:',
        deckProgress: 'Stapelfortschritt',
        overview: 'Übersicht',
        accuracy: 'Genauigkeit',
        lastReview: 'Letzte Überprüfung',
        never: 'Nie',
        today: 'Heute',
        yesterday: 'Gestern',
        daysAgo: 'Tage her',
        loading: 'Laden...',
        loadingStats: 'Statistiken werden geladen...',
        fillInBlank: 'Lücke Füllen',
        pictureWord: 'Bildwort',
        translate: 'Übersetzen',
        manageCards: 'Karten Verwalten',
        decksRefreshed: 'Stapel erfolgreich aktualisiert!',
        errorRefreshing: 'Fehler beim Aktualisieren der Stapel',
        deckCreated: 'Stapel erfolgreich erstellt!',
        deckUpdated: 'Stapel erfolgreich aktualisiert!',
        deckDeleted: 'Stapel erfolgreich gelöscht!',
        deckDeleteFailed: 'Fehler beim Löschen des Stapels. Bitte versuchen Sie es erneut.',
        enterDeckName: 'Bitte geben Sie einen Stapelnamen ein',
        cardCreated: 'Karte erfolgreich erstellt!',
        fillBlankCreated: 'Lückenfüllkarte erfolgreich erstellt!',
        pictureCardCreated: 'Bildwortkarte erfolgreich erstellt!',
        translateCardCreated: 'Übersetzungskarte erfolgreich erstellt!',
        errorSavingCard: 'Fehler beim Speichern der Karte. Bitte versuchen Sie es erneut.',
        importSuccess: 'Erfolgreich importiert',
        withCards: 'mit',
        cards2: 'Karten',
        importFailed2: 'Import fehlgeschlagen'
      },
      stats: {
        title: 'Statistiken',
        totalCards: 'Gesamtkarten',
        mastered: 'Gemeistert',
        learning: 'Lernen',
        new: 'Neu',
        studyStreak: 'Lernserie',
        days: 'Tage',
        metricsTitle: 'Was bedeuten diese Metriken?',
        masteredDesc: 'Karten, die Sie erfolgreich 3+ Mal überprüft haben',
        streakDesc: 'Aufeinanderfolgende Lerntage (wird zurückgesetzt, wenn Sie einen Tag überspringen)',
        accuracyDesc: 'Prozentsatz der richtig überprüften Karten',
        noStatsYet: 'Noch Keine Statistiken',
        startStudying: 'Beginnen Sie mit dem Lernen einiger Stapel, um Ihren Fortschritt zu sehen!',
        resetStats: 'Statistiken Zurücksetzen',
        resetConfirm: 'Sind Sie sicher, dass Sie alle Statistiken zurücksetzen möchten? Dies kann nicht rückgängig gemacht werden.',
        total: 'Gesamt',
        review: 'Überprüfen'
      }
    };

    // Italian translations
    this.translations['it-IT'] = {
      common: {
        save: 'Salva',
        cancel: 'Annulla',
        delete: 'Elimina',
        edit: 'Modifica',
        close: 'Chiudi',
        ok: 'OK',
        yes: 'Sì',
        no: 'No',
        confirm: 'Conferma',
        back: 'Indietro',
        next: 'Avanti',
        done: 'Fatto',
        loading: 'Caricamento...',
        error: 'Errore',
        success: 'Successo'
      },
      settings: {
        title: 'Impostazioni',
        languageSettings: 'Impostazioni Lingua',
        nativeLanguage: 'Lingua Madre',
        targetLanguage: 'Lingua Target',
        nativeLanguageDesc: 'Lingua dell\'interfaccia',
        targetLanguageDesc: 'Lingua che stai imparando',
        autoSpeak: 'Parla automaticamente al capovolgimento',
        appearance: 'Aspetto',
        study: 'Studio',
        data: 'Dati e Backup',
        about: 'Informazioni',
        darkMode: 'Modalità Scura',
        resetSettings: 'Ripristina Impostazioni',
        resetData: 'Ripristina Tutti i Dati',
        exportData: 'Esporta Dati',
        importData: 'Importa Dati'
      },
      tabs: {
        home: 'Home',
        decks: 'Mazzi',
        stats: 'Statistiche',
        settings: 'Impostazioni'
      },
      home: {
        title: 'Studia',
        noCards: 'Nessuna carta da studiare',
        flip: 'Capovolgi',
        showAnswer: 'Mostra Risposta',
        hard: 'Difficile',
        good: 'Bene',
        easy: 'Facile',
        incorrect: 'Sbagliato',
        correct: 'Corretto',
        sessionComplete: 'Sessione Completata!',
        cardsStudied: 'Carte Studiate',
        continueStudying: 'Continua a Studiare',
        reviewMissed: 'Rivedi Carte Sbagliate'
      },
      decks: {
        title: 'Mazzi',
        createDeck: 'Crea Mazzo',
        createNewDeck: 'Crea Nuovo Mazzo',
        editDeck: 'Modifica Mazzo',
        deleteDeck: 'Elimina Mazzo',
        deleteConfirm: 'Sei sicuro di voler eliminare questo mazzo?',
        addCard: 'Aggiungi Carta',
        addCards: 'Aggiungi Carte',
        viewStats: 'Visualizza Statistiche',
        study: 'Studia',
        deckName: 'Nome Mazzo',
        description: 'Descrizione',
        cards: 'carte',
        noDecks: 'Nessun mazzo ancora',
        createFirst: 'Crea il tuo primo mazzo per iniziare',
        refreshDecks: 'Aggiorna Mazzi',
        importDecks: 'Importa Mazzi',
        importFromFile: 'Importa da File',
        importFromUrl: 'Importa da URL',
        exportDeck: 'Esporta Mazzo',
        warning: 'Avviso',
        importWarning: 'L\'importazione sostituirà tutti i mazzi esistenti per la lingua corrente. Vuoi continuare?',
        importFailed: 'Importazione Fallita',
        importFailedMessage: 'Impossibile scaricare o analizzare il mazzo dall\'URL',
        enterUrl: 'Inserisci l\'URL di un file JSON del mazzo:',
        deckProgress: 'Progresso del Mazzo',
        overview: 'Panoramica',
        accuracy: 'Precisione',
        lastReview: 'Ultima revisione',
        never: 'Mai',
        today: 'Oggi',
        yesterday: 'Ieri',
        daysAgo: 'giorni fa',
        loading: 'Caricamento...',
        loadingStats: 'Caricamento statistiche...',
        fillInBlank: 'Riempi lo Spazio',
        pictureWord: 'Parola con Immagine',
        translate: 'Traduci',
        manageCards: 'Gestisci Carte',
        decksRefreshed: 'Mazzi aggiornati con successo!',
        errorRefreshing: 'Errore durante l\'aggiornamento dei mazzi',
        deckCreated: 'Mazzo creato con successo!',
        deckUpdated: 'Mazzo aggiornato con successo!',
        deckDeleted: 'Mazzo eliminato con successo!',
        deckDeleteFailed: 'Impossibile eliminare il mazzo. Riprova.',
        enterDeckName: 'Inserisci un nome per il mazzo',
        cardCreated: 'Carta creata con successo!',
        fillBlankCreated: 'Carta riempi spazio creata con successo!',
        pictureCardCreated: 'Carta parola-immagine creata con successo!',
        translateCardCreated: 'Carta di traduzione creata con successo!',
        errorSavingCard: 'Errore durante il salvataggio della carta. Riprova.',
        importSuccess: 'Importato con successo',
        withCards: 'con',
        cards2: 'carte',
        importFailed2: 'Importazione fallita'
      },
      stats: {
        title: 'Statistiche',
        totalCards: 'Carte Totali',
        mastered: 'Padroneggiate',
        learning: 'In Apprendimento',
        new: 'Nuove',
        studyStreak: 'Serie di Studio',
        days: 'giorni',
        metricsTitle: 'Cosa significano queste metriche?',
        masteredDesc: 'Carte che hai rivisto con successo 3+ volte',
        streakDesc: 'Giorni consecutivi di studio (si azzera se salti un giorno)',
        accuracyDesc: 'Percentuale di carte riviste correttamente',
        noStatsYet: 'Ancora Nessuna Statistica',
        startStudying: 'Inizia a studiare alcuni mazzi per vedere i tuoi progressi!',
        resetStats: 'Reimposta Statistiche',
        resetConfirm: 'Sei sicuro di voler reimpostare tutte le statistiche? Questa azione non può essere annullata.',
        total: 'Totale',
        review: 'Rivedi'
      }
    };
  }

  async setLanguage(lang: SupportedLanguage): Promise<void> {
    this.currentLanguage$.next(lang);
    await this.storageService.saveSetting('nativeLanguage', lang);
  }

  getCurrentLanguage(): SupportedLanguage {
    return this.currentLanguage$.value;
  }

  getLanguage$(): Observable<SupportedLanguage> {
    return this.currentLanguage$.asObservable();
  }

  translate(key: string): string {
    const lang = this.currentLanguage$.value;
    const keys = key.split('.');
    let value: any = this.translations[lang];

    for (const k of keys) {
      if (value && typeof value === 'object' && k in value) {
        value = value[k];
      } else {
        // Fallback to English if translation not found
        value = this.translations['en-US'];
        for (const fallbackKey of keys) {
          if (value && typeof value === 'object' && fallbackKey in value) {
            value = value[fallbackKey];
          } else {
            return key; // Return key if not found in fallback either
          }
        }
        break;
      }
    }

    return typeof value === 'string' ? value : key;
  }

  // Shorthand method
  t(key: string): string {
    return this.translate(key);
  }
}
